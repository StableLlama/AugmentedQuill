{% extends "base.html" %}
{% block title %}AugmentedQuill — Prototype{% endblock %}
{% block content %}
  <div class="aq-shell" x-data="shellView()" x-init="init()">
    <aside class="aq-sidebar">
      <div class="aq-sidebar-top">
        <h3 class="aq-sidebar-title">Chapters</h3>
        <ul class="aq-chapters">
          <template x-if="!(chapters && chapters.length)">
            <li class="aq-empty">No chapters configured</li>
          </template>
          <template x-for="ch in chapters" :key="ch.id">
            <li>
              <template x-if="editingId !== ch.id">
                <button class="aq-link" :class="{'aq-active': activeId===ch.id}" @click="openChapter(ch.id)" @dblclick.stop="startEdit(ch)" x-text="ch.title"></button>
              </template>
              <template x-if="editingId === ch.id">
                <div class="aq-edit-wrap">
                  <input type="text" x-ref="titleInput" x-model="editingTitle" @keydown.enter.prevent="saveEdit()" @keydown.escape.prevent="cancelEdit()" @blur="saveEdit()" class="aq-input-inline" style="width:100%; padding:0.25rem 0.5rem; border-radius:6px; border:1px solid #334155; background:#0b1223; color:var(--fg);" />
                  <div class="aq-edit-actions">
                    <button class="aq-btn aq-btn-sm" @click="saveEdit()">Save</button>
                    <button class="aq-btn aq-btn-sm" @click="cancelEdit()">Cancel</button>
                  </div>
                </div>
              </template>
            </li>
          </template>
          <li>
            <button class="aq-btn" style="width:100%;" @click="createChapter()">+ New chapter</button>
          </li>
        </ul>
      </div>
      <div class="aq-sidebar-bottom">
        <button class="aq-btn aq-btn-primary" hx-get="/settings" hx-target="#main" hx-swap="innerHTML">Settings</button>
      </div>
    </aside>

    <section id="main" class="aq-mainpane">
      <div class="aq-panel">
        <div class="aq-toolbar" style="gap:0.5rem; align-items:center;">
          <button id="save" class="aq-btn aq-btn-primary" :disabled="!dirty" @click="saveContent()">Save</button>
          <span x-show="dirty" style="font-size:0.9rem; color:#fbbf24; margin-left:0.5rem;">Unsaved changes</span>
          <div style="margin-left:auto; display:flex; gap:0.5rem; align-items:center;">
            <span style="font-size:0.9rem; color:#94a3b8;">Render:</span>
            <button class="aq-btn" :class="{ 'aq-btn-primary': renderMode==='raw' }" @click="renderMode='raw'">Raw</button>
            <button class="aq-btn" :class="{ 'aq-btn-primary': renderMode==='markdown' }" @click="renderMode='markdown'">Markdown</button>
          </div>
        </div>
        <div class="aq-content">
          <div class="aq-card">
            <template x-if="activeId === null">
              <div class="aq-empty">Select a chapter to view its content.</div>
            </template>
            <template x-if="activeId !== null">
              <div>
                <div style="font-weight:600; margin-bottom:0.5rem;">Chapter <span x-text="activeId"></span></div>
                <div x-show="renderMode==='markdown'" class="aq-toolbar" style="gap:0.25rem; flex-wrap:wrap;">
                  <button class="aq-btn aq-btn-sm" title="Bold" @click="wrapSelection('**','**')"><strong>B</strong></button>
                  <button class="aq-btn aq-btn-sm" title="Italic" @click="wrapSelection('*','*')"><em>I</em></button>
                  <button class="aq-btn aq-btn-sm" title="Heading" @click="insertHeading()">H1</button>
                  <button class="aq-btn aq-btn-sm" title="Link" @click="insertLink()">Link</button>
                  <button class="aq-btn aq-btn-sm" title="Code" @click="wrapSelection('`','`')">Code</button>
                  <button class="aq-btn aq-btn-sm" title="Bullet list" @click="toggleList('- ')">• List</button>
                  <button class="aq-btn aq-btn-sm" title="Quote" @click="togglePrefix('> ')">❝ Quote</button>
                </div>
                <textarea x-ref="editor" x-model="content" @input="onChanged()" rows="16" style="width:100%; resize:vertical; background:#0b1223; color:var(--fg); border:1px solid #334155; border-radius:6px; padding:0.75rem;"></textarea>
                <div class="aq-preview" x-show="renderMode==='markdown'" style="margin-top:0.75rem; padding:0.75rem; border:1px dashed #334155; border-radius:6px;">
                  <div x-html="mdToHtml(content)"></div>
                </div>
              </div>
            </template>
          </div>
          <p class="aq-tip">This is a rudimentary UI. Use the Settings button in the sidebar to configure machine and story settings.</p>
        </div>
      </div>
    </section>
  </div>
{% endblock %}
